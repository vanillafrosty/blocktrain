!function(e){var t={};function i(r){if(t[r])return t[r].exports;var n=t[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,i),n.l=!0,n.exports}i.m=e,i.c=t,i.d=function(e,t,r){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)i.d(r,n,function(t){return e[t]}.bind(null,n));return r},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=0)}([function(e,t,i){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function a(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}i.r(t);var o=function(){function e(t,i){r(this,e),this.key=t,this.val=i,this.next=null,this.last=null}return a(e,[{key:"remove",value:function(){this.next&&(this.next.last=this.last),this.last&&(this.last.next=this.next),this.next=null,this.last=null}}]),e}(),s=function(){function e(){r(this,e),this.head=new o,this.tail=new o,this.head.last=this.tail,this.tail.next=this.head}return a(e,[{key:"add",value:function(e,t){var i=new o(e,t);return i.next=this.head,i.last=this.head.last,this.head.last.next=i,this.head.last=i,i}},{key:"oldest",value:function(){return this.head.last===this.tail?null:this.tail.next}}]),e}();function h(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var u=function(){function e(t,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.count=0,this.max=t,this.map={},this.list=new s,this.pieceValues=i}var t,i,r;return t=e,(i=[{key:"get",value:function(e){if(void 0!==this.map[e]){var t=this.map[e];t.remove();var i=this.list.add(t.key,t.val);this.map[e]=i}else if(this.count<this.max){var r=this.list.add(e,this.pieceValues[e]);this.count+=1,this.map[e]=r}else{var n=this.list.oldest();n.remove(),delete this.map[n.key];var a=this.list.add(e,this.pieceValues[e]);this.map[e]=a}}}])&&h(t.prototype,i),r&&h(t,r),e}();function l(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var c=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.pieces={I:[[0,1,0,0],[0,1,0,0],[0,1,0,0],[0,1,0,0]],O:[[0,0,0,0],[0,2,2,0],[0,2,2,0],[0,0,0,0]],T:[[0,0,0],[3,3,3],[0,3,0]],L:[[0,4,0],[0,4,0],[0,4,4]],J:[[0,5,0],[0,5,0],[5,5,0]],Z:[[0,0,0],[6,6,0],[0,6,6]],S:[[0,0,0],[0,7,7],[7,7,0]]},this.bag=["I","O","T","L","J","Z","S"],this.lru=new u(3,this.pieces)}var t,i,r;return t=e,(i=[{key:"shuffle",value:function(){for(var e,t,i=this.bag.length-1;i>=0;i--)e=Math.floor(Math.random()*(i+1)),t=this.bag[i],this.bag[i]=this.bag[e],this.bag[e]=t;return this.bag}},{key:"newPiece",value:function(){for(var e=this.shuffle()[0];void 0!==this.lru.map[e];)e=this.shuffle()[0];return this.lru.get(e),{type:e,matrix:this.lru.map[e].val}}}])&&l(t.prototype,i),r&&l(t,r),e}();function f(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var v=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.AI=!1,this.gameOverOnce=!1,this.animationFrame=null,this.board=t,this.offset={x:4,y:0},this.totalRotations=0,this.pieces=new c,this.currentPiece=this.pieces.newPiece(),this.nextPiece=this.pieces.newPiece(),this.startTime,this.resetTime=0,this.foreverTime=0,this.timeStep=1e3,this.megamanPlaying=!1,this.playingGame=!1,this.gameOver=!1,this.megamanAudio=document.getElementById("megaman-theme")}var t,i,r;return t=e,(i=[{key:"toggleAudio",value:function(){(this.playingGame||this.gameOver)&&(this.megamanPlaying?(this.megamanAudio.pause(),this.megamanPlaying=!1):(this.megamanAudio.play(),this.megamanPlaying=!0))}},{key:"transpose",value:function(e){for(var t,i=0;i<e.length;i++)for(var r=i+1;r<e.length;r++)t=e[i][r],e[i][r]=e[r][i],e[r][i]=t;return e}},{key:"rotate",value:function(e){this.transpose(e);for(var t,i=0;i<e.length;i++)for(var r=0;r<Math.floor(e.length/2);r++)t=e[i][r],e[i][r]=e[i][e.length-1-r],e[i][e.length-1-r]=t;return e}},{key:"rotateCounter",value:function(e){this.transpose(e);for(var t,i=0;i<Math.floor(e.length/2);i++)for(var r=0;r<e.length;r++)t=e[i][r],e[i][r]=e[e.length-1-i][r],e[e.length-1-i][r]=t;return e}},{key:"handleRotate",value:function(e){switch(e.type){case"T":case"O":case"J":case"L":return e.matrix=this.rotate(e.matrix),e;case"Z":case"S":case"I":return this.totalRotations+=1,this.totalRotations%2!=0?e.matrix=this.rotate(e.matrix):e.matrix=this.rotateCounter(e.matrix),e}}},{key:"handleUnrotate",value:function(e){switch(e.type){case"T":case"O":case"J":case"L":return e.matrix=this.rotateCounter(e.matrix),e;case"Z":case"S":case"I":return this.totalRotations%2!=0?e.matrix=this.rotateCounter(e.matrix):e.matrix=this.rotate(e.matrix),e}}},{key:"boardStep",value:function(){this.board.render(),this.board.drawPiece(this.currentPiece.matrix,this.offset),this.board.drawNext(this.nextPiece.matrix)}},{key:"addKeyListeners",value:function(){var e=this;document.addEventListener("keydown",(function(t){switch(t.key){case"d":case"ArrowRight":e.gameOver||(e.offset.x+=1,e.board.validPos(e.currentPiece.matrix,e.offset)?e.boardStep():e.offset.x-=1);break;case"a":case"ArrowLeft":e.gameOver||(e.offset.x-=1,e.board.validPos(e.currentPiece.matrix,e.offset)?e.boardStep():e.offset.x+=1);break;case"s":case"ArrowDown":t.preventDefault(),e.gameOver||(e.offset.y+=1,e.board.update(e.currentPiece.matrix,e.offset)&&(e.offset.y=0,e.offset.x=4,e.totalRotations=0,e.currentPiece=e.nextPiece,e.nextPiece=e.pieces.newPiece()),e.resetTime=0,e.boardStep(),e.gameOver=e.board.checkGameOver(e.currentPiece.matrix,e.offset),e.gameOver&&(e.gameOverOnce=!0,e.playingGame=!1,document.getElementById("not-game-over").setAttribute("id","game-over"),cancelAnimationFrame(e.animationFrame)));break;case"w":case"ArrowUp":t.preventDefault(),e.currentPiece=e.handleRotate(e.currentPiece);var i=e.board.validateRotate(e.currentPiece.matrix,e.offset);i.reRotate?e.currentPiece=e.handleUnrotate(e.currentPiece):e.offset=i.offset,e.boardStep();break;case" ":t.preventDefault(),e.gameOver||(t.preventDefault(),e.board.handleDrop(e.currentPiece.matrix,e.offset),e.offset.y=0,e.offset.x=4,e.totalRotations=0,e.currentPiece=e.nextPiece,e.nextPiece=e.pieces.newPiece(),e.boardStep())}}))}},{key:"restart",value:function(){this.board.ctx.clearRect(0,0,this.board.width,this.board.height),this.board.emptyBoard(),document.getElementById("game-over").setAttribute("id","not-game-over"),this.animationFrame=null,this.offset={x:4,y:0},this.totalRotations=0,this.currentPiece=this.pieces.newPiece(),this.nextPiece=this.pieces.newPiece(),this.startTime=null,this.resetTime=0,this.timeStep=1e3,this.foreverTime=0,this.gameOver=!1,this.play()}},{key:"play",value:function(){var e=this;if(this.playingGame||this.gameOver)return!0;this.playingGame=!0,this.megamanAudio.play(),this.megamanPlaying=!0,this.gameOverOnce||(this.addKeyListeners(),document.getElementById("before-game-start").setAttribute("id","game-start")),this.animationFrame=requestAnimationFrame((function(t){e.startTime=t,e.board.drawPiece(e.currentPiece.matrix,e.offset),e.board.drawNext(e.nextPiece.matrix),function t(i){if(e.resetTime+=i-e.startTime,e.foreverTime+=i-e.startTime,e.foreverTime>32e3&&(e.foreverTime=0,e.timeStep=.9*e.timeStep),e.resetTime>e.timeStep&&(e.resetTime=0,e.offset.y+=1,e.board.update(e.currentPiece.matrix,e.offset)&&(e.offset.y=0,e.offset.x=4,e.totalRotations=0,e.currentPiece=e.nextPiece,e.nextPiece=e.pieces.newPiece()),e.boardStep(),e.gameOver=e.board.checkGameOver(e.currentPiece.matrix,e.offset),e.gameOver))return e.gameOverOnce=!0,e.playingGame=!1,document.getElementById("not-game-over").setAttribute("id","game-over"),cancelAnimationFrame(e.animationFrame),!0;e.startTime=i,e.animationFrame=requestAnimationFrame(t)}(t)}))}}])&&f(t.prototype,i),r&&f(t,r),e}(),d=function(e,t){return t<Math.floor(e.length/2)?"left":"right"},m=function(e,t,i){return!(e<t||e>i)},g=function(e,t,i,r){for(var n,a,o=0;o<e.length;o++)for(var s=0;s<e[0].length;s++)if(0!==e[o][s]){for(a=0;o+t.y+a<i&&!r[o+t.y+a][s+t.x];)a+=1;(!n||a<n)&&(n=a)}return n},y=function(e){for(var t=new Array(e.length),i=0;i<t.length;i++)t[i]=new Array(e[0].length);for(var r=0;r<e.length;r++)for(var n=0;n<e[0].length;n++)t[r][n]=e[r][n];return t},p=function(e,t){return Math.floor(Math.pow(Math.random(),2)*(t-e+1)+e)},x=function(e,t){return 0===Math.round(Math.random())?e:t};function w(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var k=function(){function e(t,i,r,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.ctx=r,this.nextPieceCtx=n,this.width=t,this.height=i,this.rows=21,this.cols=10,this.grid=[],this.strokeStyle="#000000",this.outlineStrokeStyle="#F9F9F9",this.square_width=t/this.cols;for(var a=0;a<this.rows;a++)this.grid[a]=new Array(this.cols);this.colors={1:"#E24242",2:"#F5DC41",3:"#CC41F5",4:"#3E4AE8",5:"#3EE0E8",6:"#3EE848",7:"#F14D17"},this.emptyBoard=this.emptyBoard.bind(this)}var t,i,r;return t=e,(i=[{key:"emptyBoard",value:function(){for(var e=0;e<this.rows;e++)for(var t=0;t<this.cols;t++)this.grid[e][t]=void 0}},{key:"render",value:function(){this.ctx.clearRect(0,0,this.width,this.height);for(var e=0;e<this.rows;e++)for(var t=0;t<this.cols;t++)if(void 0!==this.grid[e][t]){var i=t*this.square_width,r=e*this.square_width,n=this.colors[this.grid[e][t]];this.drawSquare(i,r,n)}}},{key:"drawPiece",value:function(e,t){var i,r,n,a,o,s={x:t.x,y:t.y};i=g(e,t,this.rows,this.grid),s.y+=i-1;for(var h=0;h<e.length;h++)for(var u=0;u<e[0].length;u++)0!==e[h][u]&&(r=(t.x+u)*this.square_width,n=(t.y+h)*this.square_width,a=(s.y+h)*this.square_width,o=this.colors[e[h][u]],this.drawSquare(r,n,o),this.drawSquareOutline(r,a,o))}},{key:"drawNext",value:function(e){var t=0,i=1;this.nextPieceCtx.clearRect(0,0,120,150);for(var r=0;r<e.length;r++)for(var n=0;n<e[0].length;n++)if(0!==e[r][n]){var a=(t+n)*this.square_width,o=(i+r)*this.square_width,s=this.colors[e[r][n]];this.drawNextSquare(a,o,s)}}},{key:"drawNextSquare",value:function(e,t,i){var r=this.square_width;this.nextPieceCtx.fillStyle=i,this.nextPieceCtx.strokeStyle=this.strokeStyle,this.nextPieceCtx.lineWidth=2,this.nextPieceCtx.fillRect(e,t,r,r),this.nextPieceCtx.strokeRect(e,t,r,r),this.nextPieceCtx.beginPath(),this.nextPieceCtx.moveTo(e+r/4,t+r*(3/4)),this.nextPieceCtx.lineTo(e+r/4,t+r/4),this.nextPieceCtx.lineTo(e+r*(3/4),t+r/4),this.nextPieceCtx.stroke()}},{key:"drawSquare",value:function(e,t,i){var r=this.square_width;this.ctx.fillStyle=i,this.ctx.strokeStyle=this.strokeStyle,this.ctx.lineWidth=2,this.ctx.fillRect(e,t,r,r),this.ctx.strokeRect(e,t,r,r),this.ctx.beginPath(),this.ctx.moveTo(e+r/4,t+r*(3/4)),this.ctx.lineTo(e+r/4,t+r/4),this.ctx.lineTo(e+r*(3/4),t+r/4),this.ctx.stroke()}},{key:"drawSquareOutline",value:function(e,t,i){var r=this.square_width;this.ctx.strokeStyle=this.outlineStrokeStyle,this.ctx.lineWidth=2,this.ctx.strokeRect(e,t,r,r)}},{key:"update",value:function(e,t){if(t.y<0)return!1;for(var i=0;i<e.length;i++)for(var r=0;r<e[0].length;r++)if(0!==e[i][r]){var n=t.x+r,a=t.y+i;if(a>=this.rows||void 0!==this.grid[a][n])return this.setPiece(e,t.x,t.y-1),this.clearRows(e.length,t.y-1),!0}return!1}},{key:"clearRows",value:function(e,t){for(var i=0;i<e;i++)this.fullRow(t+i)&&this.removeRow(t+i)}},{key:"fullRow",value:function(e){var t=this.grid[e];if(void 0===t)return!1;for(var i=0;i<t.length;i++)if(void 0===t[i])return!1;return!0}},{key:"removeRow",value:function(e){for(var t=this.grid[e],i=e-1;i>=0;i--)for(var r=0;r<t.length;r++)this.grid[i+1][r]=this.grid[i][r];for(var n=0;n<t.length;n++)this.grid[0][n]=void 0}},{key:"setPiece",value:function(e,t,i){for(var r=0;r<e.length;r++)for(var n=0;n<e[0].length;n++)0!==e[r][n]&&(this.grid[i+r][t+n]=e[r][n])}},{key:"validPos",value:function(e,t){for(var i=0;i<e.length;i++)for(var r=0;r<e[0].length;r++)if(0!==e[i][r]){var n=t.x+r,a=t.y+i;if(!m(n,0,this.cols-1)||!m(a,0,this.rows-1))return!1;if(void 0!==this.grid[a][n])return!1}return!0}},{key:"handleResponse",value:function(e,t,i){return this.validPos(e,i)?{reRotate:!1,offset:i}:{reRotate:!0,offset:t}}},{key:"handleX",value:function(e,t,i){var r={x:i.x,y:i.y};return m(e,0,this.cols-1)?null:e<0?(r.x+=1,this.handleResponse(t,i,r)):e>this.cols-1?(r.x-=1,this.handleResponse(t,i,r)):void 0}},{key:"handleY",value:function(e,t,i){var r={x:i.x,y:i.y};return m(e,0,this.rows-1)?null:e<0?(r.y+=1,this.handleResponse(t,i,r)):e>this.rows-1?(r.y-=1,this.handleResponse(t,i,r)):void 0}},{key:"handleP",value:function(e,t,i){var r={x:i.x,y:i.y};if("left"===d(t,e)){r.x+=1;var n=this.handleResponse(t,i,r);return n.reRotate?(r.x-=1,r.y-=1,this.handleResponse(t,i,r)):n}if("right"===d(t,e)){r.x-=1;var a=this.handleResponse(t,i,r);return a.reRotate?(r.x+=1,r.y-=1,this.handleResponse(t,i,r)):a}}},{key:"validateRotate",value:function(e,t){for(var i,r,n=0;n<e.length;n++)for(var a=0;a<e[0].length;a++)if(0!==e[n][a]){var o=t.x+a,s=t.y+n;if(i=this.handleX(o,e,t))return i;if(r=this.handleY(s,e,t))return r;if(void 0!==this.grid[s][o])return this.handleP(o,e,t)}return{reRotate:!1,offset:t}}},{key:"handleDrop",value:function(e,t){var i;i=g(e,t,this.rows,this.grid),t.y+=i,this.setPiece(e,t.x,t.y-1),this.clearRows(e.length,t.y-1)}},{key:"checkGameOver",value:function(e,t){return 0===t.y&&!this.validPos(e,t)}},{key:"fullRows",value:function(e,t){for(var i=0,r=0;r<e;r++)this.fullRow(t+r)&&(i+=1);return i}},{key:"getMaxHeight",value:function(){for(var e=10,t=0,i=0;i<this.rows;i++)for(var r=0;r<this.cols&&0!==e;r++)void 0!==this.grid[i][r]&&(e-=1,this.rows-i>t&&(t=this.rows-i));return t}},{key:"getCumulativeHeight",value:function(e){for(var t=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],i=10,r=0;r<this.rows;r++)for(var n=0;n<this.cols&&0!==i;n++)void 0!==this.grid[r][n]&&t[n]<0&&(t[n]=this.rows-r,i-=1);for(var a=0,o=0;o<t.length;o++)t[o]>0&&(a+=t[o]);return a-10*e}},{key:"getRelativeHeight",value:function(){for(var e=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],t=10,i=99,r=0,n=0;n<this.rows;n++)for(var a=0;a<this.cols&&0!==t;a++)void 0!==this.grid[n][a]&&e[a]<0&&(e[a]=this.rows-n,t-=1,e[a]>r&&(r=e[a]),e[a]<i&&(i=e[a]));return r-i}},{key:"getHoles",value:function(){for(var e=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],t=10,i=0;i<this.rows;i++)for(var r=0;r<this.cols&&0!==t;r++)void 0!==this.grid[i][r]&&e[r]<0&&(e[r]=this.rows-i,t-=1);for(var n=0,a=0;a<e.length;a++)for(var o=20;o>this.rows-e[a];o--)void 0===this.grid[o][a]&&(n+=1);return n}},{key:"getRoughness",value:function(){for(var e=0,t=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],i=10,r=0;r<this.rows;r++)for(var n=0;n<this.cols&&0!==i;n++)void 0!==this.grid[r][n]&&t[n]<0&&(t[n]=this.rows-r,i-=1);for(var a=0;a<t.length-1;a++){var o=t[a+1]<0?0:t[a+1];e+=Math.abs(t[a]-o)}return e}},{key:"removePiece",value:function(e,t,i){for(var r=0;r<e.length;r++)for(var n=0;n<e[0].length;n++)0!==e[r][n]&&(this.grid[i+r][t+n]=void 0)}}])&&w(t.prototype,i),r&&w(t,r),e}();function b(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var P=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.grid=t,this.rows=t.length,this.cols=t[0].length,this.emptyBoard=this.emptyBoard.bind(this)}var t,i,r;return t=e,(i=[{key:"emptyBoard",value:function(){for(var e=0;e<this.rows;e++)for(var t=0;t<this.cols;t++)this.grid[e][t]=void 0}},{key:"update",value:function(e,t){if(t.y<0)return!1;for(var i=0;i<e.length;i++)for(var r=0;r<e[0].length;r++)if(0!==e[i][r]){var n=t.x+r,a=t.y+i;if(a>=this.rows||void 0!==this.grid[a][n])return this.setPiece(e,t.x,t.y-1),this.clearRows(e.length,t.y-1),!0}return!1}},{key:"clearRows",value:function(e,t){for(var i=0;i<e;i++)this.fullRow(t+i)&&this.removeRow(t+i)}},{key:"fullRow",value:function(e){var t=this.grid[e];if(void 0===t)return!1;for(var i=0;i<t.length;i++)if(void 0===t[i])return!1;return!0}},{key:"removeRow",value:function(e){for(var t=this.grid[e],i=e-1;i>=0;i--)for(var r=0;r<t.length;r++)this.grid[i+1][r]=this.grid[i][r];for(var n=0;n<t.length;n++)this.grid[0][n]=void 0}},{key:"setPiece",value:function(e,t,i){for(var r=0;r<e.length;r++)for(var n=0;n<e[0].length;n++)0!==e[r][n]&&(this.grid[i+r][t+n]=e[r][n])}},{key:"validPos",value:function(e,t){for(var i=0;i<e.length;i++)for(var r=0;r<e[0].length;r++)if(0!==e[i][r]){var n=t.x+r,a=t.y+i;if(!m(n,0,this.cols-1)||!m(a,0,this.rows-1))return!1;if(void 0!==this.grid[a][n])return!1}return!0}},{key:"handleResponse",value:function(e,t,i){return this.validPos(e,i)?{reRotate:!1,offset:i}:{reRotate:!0,offset:t}}},{key:"handleX",value:function(e,t,i){var r={x:i.x,y:i.y};return m(e,0,this.cols-1)?null:e<0?(r.x+=1,this.handleResponse(t,i,r)):e>this.cols-1?(r.x-=1,this.handleResponse(t,i,r)):void 0}},{key:"handleY",value:function(e,t,i){var r={x:i.x,y:i.y};return m(e,0,this.rows-1)?null:e<0?(r.y+=1,this.handleResponse(t,i,r)):e>this.rows-1?(r.y-=1,this.handleResponse(t,i,r)):void 0}},{key:"handleP",value:function(e,t,i){var r={x:i.x,y:i.y};if("left"===d(t,e)){r.x+=1;var n=this.handleResponse(t,i,r);return n.reRotate?(r.x-=1,r.y-=1,this.handleResponse(t,i,r)):n}if("right"===d(t,e)){r.x-=1;var a=this.handleResponse(t,i,r);return a.reRotate?(r.x+=1,r.y-=1,this.handleResponse(t,i,r)):a}}},{key:"validateRotate",value:function(e,t){for(var i,r,n=0;n<e.length;n++)for(var a=0;a<e[0].length;a++)if(0!==e[n][a]){var o=t.x+a,s=t.y+n;if(i=this.handleX(o,e,t))return i;if(r=this.handleY(s,e,t))return r;if(void 0!==this.grid[s][o])return this.handleP(o,e,t)}return{reRotate:!1,offset:t}}},{key:"handleDrop",value:function(e,t){var i,r;i=g(e,t,this.rows,this.grid),t.y+=i,r=0===t.y?0:t.y-1,this.setPiece(e,t.x,r),this.clearRows(e.length,r)}},{key:"checkGameOver",value:function(e,t){return 0===t.y&&!this.validPos(e,t)}},{key:"fullRows",value:function(e,t){for(var i=0,r=0;r<e;r++)this.fullRow(t+r)&&(i+=1);return i}},{key:"getMaxHeight",value:function(){for(var e=10,t=0,i=0;i<this.rows;i++)for(var r=0;r<this.cols&&0!==e;r++)void 0!==this.grid[i][r]&&(e-=1,this.rows-i>t&&(t=this.rows-i));return t}},{key:"getCumulativeHeight",value:function(e){for(var t=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],i=10,r=0;r<this.rows;r++)for(var n=0;n<this.cols&&0!==i;n++)void 0!==this.grid[r][n]&&t[n]<0&&(t[n]=this.rows-r,i-=1);for(var a=0,o=0;o<t.length;o++)t[o]>0&&(a+=t[o]);return a-10*e}},{key:"getRelativeHeight",value:function(){for(var e=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],t=10,i=99,r=0,n=0;n<this.rows;n++)for(var a=0;a<this.cols&&0!==t;a++)void 0!==this.grid[n][a]&&e[a]<0&&(e[a]=this.rows-n,t-=1,e[a]>r&&(r=e[a]),e[a]<i&&(i=e[a]));return r-i}},{key:"getHoles",value:function(){for(var e=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],t=10,i=0;i<this.rows;i++)for(var r=0;r<this.cols&&0!==t;r++)void 0!==this.grid[i][r]&&e[r]<0&&(e[r]=this.rows-i,t-=1);for(var n=0,a=0;a<e.length;a++)for(var o=0;o<e[a];o++)void 0===this.grid[o][a]&&(n+=1);return n}},{key:"getRoughness",value:function(){for(var e=0,t=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],i=10,r=0;r<this.rows;r++)for(var n=0;n<this.cols&&0!==i;n++)void 0!==this.grid[r][n]&&t[n]<0&&(t[n]=this.rows-r,i-=1);for(var a=0;a<t.length-1;a++){var o=t[a+1]<0?0:t[a+1];e+=Math.abs(t[a]-o)}return e}},{key:"removePiece",value:function(e,t,i){for(var r=0;r<e.length;r++)for(var n=0;n<e[0].length;n++)0!==e[r][n]&&(this.grid[i+r][t+n]=void 0)}}])&&b(t.prototype,i),r&&b(t,r),e}();function R(e){return(R="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function S(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function O(e,t){return(O=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function T(e,t){return!t||"object"!==R(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function I(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}function M(e){return(M=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var C=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&O(e,t)}(o,e);var t,i,r,n,a=(t=o,function(){var e,i=M(t);if(I()){var r=M(this).constructor;e=Reflect.construct(i,arguments,r)}else e=i.apply(this,arguments);return T(this,e)});function o(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),(t=a.call(this,e)).AI=!0,t.populationSize=50,t.genomes=[],t.genomeIndex=-1,t.movesTaken=0,t.movesLimit=500,t.genZero=!1,t.createInitialPopulation(),t.timeStep=90,t.score=0,t.generation=25,t.mutationRate=.05,t.mutationStep=.2,t.speedArr=[300,90,10,0],t.speedIndex=1,t.powerSteps=5,t}return i=o,(r=[{key:"createInitialPopulation",value:function(){for(var e,t=0;t<this.populationSize;t++)e=this.genZero?{id:Math.random(),rowsCleared:Math.random()-.5,weightedHeight:Math.random()-.5,cumulativeHeight:Math.random()-.5,relativeHeight:Math.random()-.5,holes:.5*Math.random(),roughness:Math.random()-.5}:{cumulativeHeight:-.5959229477940513,holes:.078680173605579,id:.5532957017242564,relativeHeight:.0266789627391546,roughness:-.10651581907940999,rowsCleared:.4944378291698683,weightedHeight:.003521223515799754},this.genomes.push(e);this.evaluateNextGenome()}},{key:"evaluateNextGenome",value:function(){if(this.score=0,this.genomeIndex+=1,this.playingGame){var e=document.getElementById("ai-display");e.children[2].innerHTML="current genome: ".concat(this.genomeIndex+1,"/").concat(this.populationSize),this.genomeIndex>=this.genomes.length&&(this.evolve(),e.children[2].innerHTML="current genome: ".concat(this.genomeIndex+1,"/").concat(this.populationSize))}this.movesTaken=0,this.makeNextMove()}},{key:"makeNextMove",value:function(){if(this.movesTaken+=1,this.movesTaken>this.movesLimit)this.genomes[this.genomeIndex].fitness=this.score,this.evaluateNextGenome();else{for(var e,t,i=this.getPossibleMoves(this.board,this.currentPiece),r=0;r<i.length;r++)this.shadowBoard=new P(y(this.board.grid)),this.shadowMove(i[r],this.currentPiece),(e=this.getHighestRatedMove(this.getPossibleMoves(this.shadowBoard,this.nextPiece)))&&(i[r].rating+=e.rating);t=this.getHighestRatedMove(i),this.updateScore(t),this.realMove(t,this.currentPiece),this.timeStep>0&&this.boardStep()}}},{key:"updateScore",value:function(e){if(!e)return!0;switch(this.score+=e.drop,e.algorithm.rowsCleared){case 1:return this.score+=400,!0;case 2:return this.score+=1e3,!0;case 3:return this.score+=3e3,!0;case 4:return this.score+=12e3,!0}}},{key:"getPossibleMoves",value:function(e,t){for(var i={x:this.offset.x,y:this.offset.y},r=[],n={T:4,O:1,J:4,L:4,Z:2,S:2,I:2}[t.type],a=1;a<=n;a++){t=this.handleRotate(t);for(var o=-5;o<=5;o++){var s=!1;if(this.offset.x=i.x,this.offset.y=i.y,this.offset.x+=o,e.validPos(t.matrix,this.offset)){var h=g(t.matrix,this.offset,e.rows,e.grid);this.offset.y+=h,e.setPiece(t.matrix,this.offset.x,this.offset.y-1);var u=e.fullRows(t.length,this.offset.y-1);0===u&&(s=e.checkGameOver(this.nextPiece.matrix,i));var l={rowsCleared:u,weightedHeight:Math.pow(e.getMaxHeight(),1.5),cumulativeHeight:e.getCumulativeHeight(u),relativeHeight:e.getRelativeHeight(),holes:e.getHoles(),roughness:e.getRoughness()},c=this.updateRating(l);s&&(c-=500),e.removePiece(t.matrix,this.offset.x,this.offset.y-1),r.push({rotations:a,translation:o,rating:c,algorithm:l,drop:h-1})}}}return this.offset=i,this.totalRotations=0,r}},{key:"updateRating",value:function(e){var t=0;return t+=e.rowsCleared*this.genomes[this.genomeIndex].rowsCleared,t+=e.weightedHeight*this.genomes[this.genomeIndex].weightedHeight,t+=e.cumulativeHeight*this.genomes[this.genomeIndex].cumulativeHeight,t+=e.relativeHeight*this.genomes[this.genomeIndex].relativeHeight,t+=e.holes*this.genomes[this.genomeIndex].holes,t+=e.roughness*this.genomes[this.genomeIndex].roughness}},{key:"multiRotate",value:function(e,t){for(var i=0;i<t;i++)e=this.handleRotate(e);return e}},{key:"shadowMove",value:function(e,t){var i=y(t.matrix);t=this.multiRotate(t,e.rotations);var r={x:this.offset.x,y:this.offset.y};r.x+=e.translation,this.shadowBoard.handleDrop(t.matrix,r),t.matrix=i}},{key:"realMove",value:function(e,t){if(!e)return!0;t=this.multiRotate(t,e.rotations),this.offset.x+=e.translation,this.totalRotations=0}},{key:"getHighestRatedMove",value:function(e){var t=e[0];if(0===e.length)return null;for(var i=1;i<e.length;i++)e[i].rating>t.rating&&(t=e[i]);return t}},{key:"play",value:function(){var e=this;if(this.playingGame||this.gameOver)return!0;if(this.playingGame=!0,this.megamanAudio.play(),this.megamanPlaying=!0,!this.gameOverOnce){this.addKeyListeners(),document.getElementById("before-game-start").setAttribute("id","game-start");for(var t=document.getElementById("controls-container");t.children.length>1;)t.removeChild(t.children[1]);var i=document.getElementById("ai-display-none");i.setAttribute("id","ai-display"),i.children[1].append(" ".concat(this.generation)),i.children[2].append(" ".concat(this.genomeIndex+1,"/").concat(this.populationSize))}this.animationFrame=requestAnimationFrame((function(t){e.startTime=t,e.board.drawPiece(e.currentPiece.matrix,e.offset),e.board.drawNext(e.nextPiece.matrix),function t(i){e.resetTime+=i-e.startTime,0===e.timeStep?e.powerWalk():e.resetTime>e.timeStep&&(e.resetTime=0,e.offset.y+=1,e.board.update(e.currentPiece.matrix,e.offset)&&e.moveIteration(),e.boardStep(),e.gameOver=e.board.checkGameOver(e.currentPiece.matrix,e.offset),e.gameOver&&e.boardIteration()),e.startTime=i,e.animationFrame=requestAnimationFrame(t)}(t)}))}},{key:"evolve",value:function(){this.generation+=1,document.getElementById("ai-display").children[1].innerHTML="current generation: ".concat(this.generation),this.genomeIndex=0,this.movesTaken=0,this.scrubBoard(),this.genomes.sort((function(e,t){return t.fitness-e.fitness}));for(var e=this.genomes.slice(0,Math.floor(this.populationSize/2)),t=[this.genomes[0]];t.length<this.populationSize;)t.push(this.makeChild(e));this.genomes=t}},{key:"makeChild",value:function(e){for(var t=e[p(0,e.length-1)],i=e[p(0,e.length-1)];i===t;)i=e[p(0,e.length-1)];var r={id:Math.random(),rowsCleared:x(t.rowsCleared,i.rowsCleared),weightedHeight:x(t.weightedHeight,i.weightedHeight),cumulativeHeight:x(t.cumulativeHeight,i.cumulativeHeight),relativeHeight:x(t.relativeHeight,i.relativeHeight),holes:x(t.holes,i.holes),roughness:x(t.roughness,i.roughness),fitness:-1};return this.mutate(r),r}},{key:"mutate",value:function(e){for(var t=Object.keys(e),i=0;i<t.length;i++)"fitness"!==t[i]&&Math.random()<this.mutationRate&&(e[t[i]]=e[t[i]]+Math.random()*this.mutationStep*2-this.mutationStep)}},{key:"addKeyListeners",value:function(){var e=this;document.addEventListener("keydown",(function(t){"s"===t.key?(e.speedIndex=(e.speedIndex+1)%e.speedArr.length,e.timeStep=e.speedArr[e.speedIndex]):"z"===t.key&&(e.genZero=!0,e.genomes=[],e.genomeIndex=-1,e.movesTaken=0,e.movesLimit=500,e.timeStep=90,e.speedIndex=1,e.generation=0,e.scrubBoard(),document.getElementById("ai-display").children[1].innerHTML="current generation: ".concat(e.generation),e.createInitialPopulation())}))}},{key:"moveIteration",value:function(){this.offset.y=0,this.offset.x=4,this.totalRotations=0,this.currentPiece=this.nextPiece,this.nextPiece=this.pieces.newPiece(),this.makeNextMove()}},{key:"boardIteration",value:function(){this.genomes[this.genomeIndex].fitness=this.score,this.scrubBoard(),this.evaluateNextGenome()}},{key:"scrubBoard",value:function(){this.score=0,this.totalRotations=0,this.currentPiece=this.nextPiece,this.nextPiece=this.pieces.newPiece(),this.board.emptyBoard()}},{key:"powerStep",value:function(){this.board.handleDrop(this.currentPiece.matrix,this.offset),this.moveIteration(),this.gameOver=this.board.checkGameOver(this.currentPiece.matrix,this.offset),this.gameOver&&this.boardIteration()}},{key:"powerWalk",value:function(){for(var e=0;e<this.powerSteps;e++)this.powerStep()}}])&&S(i.prototype,r),n&&S(i,n),o}(v);document.addEventListener("DOMContentLoaded",(function(){var e=document.getElementById("canvas");e.width=300,e.height=630;var t=document.getElementById("next-piece-canvas");t.width=120,t.height=150;var i,r=e.getContext("2d"),n=t.getContext("2d"),a=new k(e.width,e.height,r,n),o=["./music/metal-man.mp3","./music/crash-man.mp3","./music/dr-wily.mp3"],s=0,h=document.getElementById("megaman-theme");h.addEventListener("ended",(function(){s=(s+1)%o.length,h.src=o[s],h.play()})),document.addEventListener("keypress",(function(e){"p"===e.key?(i||(i=new v(a)),i.play()):"a"===e.key&&(i||(i=new C(a)),i.play())})),document.addEventListener("keypress",(function(e){"m"===e.key?i.toggleAudio():"r"===e.key&&!i.AI&&i.gameOver&&i.restart()}))}))}]);
//# sourceMappingURL=bundle.js.map